<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grand Exchange</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #333;
        color: white;
        padding: 10px;
      }
      header h1 {
        margin: 0;
      }
      header button {
        background-color: #555;
        color: white;
        border: none;
        padding: 10px;
        cursor: pointer;
      }
      #main-content {
        margin: 20px;
      }
      #item-display,
      #inventory {
        border: 1px solid #ddd;
        padding: 20px;
        background-color: white;
        margin-bottom: 20px;
        width: 100%;
      }
      #item-display img {
        max-width: 100%;
      }
      #cart {
        border: 1px solid #ddd;
        padding: 20px;
        background-color: white;
        display: none;
        position: absolute;
        right: 20px;
        top: 60px;
        width: 300px;
      }
      .item-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      .item-grid .item {
        border: 1px solid #ddd;
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        height: 200px; /* Ensures uniform grid item height */
        box-sizing: border-box; /* Ensures padding is included in height */
      }
      .item-grid .item img {
        max-width: 100px;
        max-height: 100px;
      }
      .toggle-button {
        margin-top: 10px;
      }
      .warning {
        color: red;
        font-size: 0.9em;
      }
      #review-form {
        margin-top: 20px;
      }
      #review-form input[type="text"],
      #review-form input[type="number"] {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        box-sizing: border-box;
      }
      #review-form input[type="button"] {
        padding: 10px;
        margin: 5px 0;
      }
      #reviews {
        margin-top: 20px;
      }
      .cart-item-warning {
        font-size: 0.8em;
        color: red;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Grand Exchange</h1>
      <div>
        <button onclick="toggleCart()">View Cart</button>
        <select id="currencySelector" onchange="convertCurrency()">
          <option selected value="CAD">CAD</option>
          <option value="USD">USD</option>
          <option value="GP">Gold Pieces</option>
        </select>
      </div>
    </header>
    <div id="main-content">
      <div id="item-display">
        <div id="selected-item">
          <!-- Item details will be displayed here -->
        </div>
        <button onclick="addToCartMain()" class="toggle-button">
          Add to Cart
        </button>
        <button onclick="toggleReviews()" class="toggle-button">
          Show Reviews
        </button>
        <div id="reviews" style="display: none">
          <!-- Reviews will be displayed here -->
          <button onclick="showReviewForm()" class="toggle-button">
            Add a Review
          </button>
        </div>
        <div id="review-form" style="display: none">
          <h2>Leave a Review</h2>
          <p>Product: <span id="product-name"></span></p>
          <p>
            Your Name: <input type="text" id="customerNameInput" size="30" />
          </p>
          <p>
            Rating: <input type="number" id="leaveRatingInput" />&nbsp;<span
              id="addRatingValidationMessage"></span>
          </p>
          <p>Review: <input type="text" id="leaveReviewInput" size="100" /></p>
          <p>
            <input
              type="button"
              value="Submit Review"
              onclick="leaveItemReview()" />
            <input type="button" value="Cancel" onclick="cancelReview()" />
          </p>
        </div>
        <button onclick="previousItem()" class="toggle-button">Previous</button>
        <button onclick="nextItem()" class="toggle-button">Next</button>
      </div>
      <div id="inventory">
        <h2>Inventory</h2>
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
          <select id="displayFilter" onchange="displayFilteredItems()">
            <option>All</option>
            <option>weapon</option>
            <option>armour</option>
            <option>potion</option>
          </select>
        </div>
        <div id="inventoryOutput" class="item-grid"></div>
      </div>
    </div>
    <div id="cart">
      <h2>Your Cart</h2>
      <div id="cartOutput"></div>
      <button onclick="checkout()">Checkout</button>
      <div id="checkoutMessage"></div>
    </div>

    <script>
      // Global variables
      let cart = [];
      let cartItems = [];
      let currentItemIndex = 0;
      let filteredItems = [];

      // Store items constructor function
      function StoreItem(
        id,
        name,
        price,
        quantityAvailable,
        maxPerClient,
        category,
        processingFee,
        description,
        reviews,
        image,
        qty,
        subtotal
      ) {
        this.id = id;
        this.name = name;
        this.price = price;
        this.quantityAvailable = quantityAvailable;
        this.maxPerClient = maxPerClient;
        this.category = category;
        this.processingFee = processingFee;
        this.description = description;
        this.reviews = reviews || [];
        this.image = image;
        this.qty = qty;
        this.subtotal = subtotal;
      }

      // Reviews array constructor
      function Review(rating, customerName, description) {
        this.rating = rating;
        this.customerName = customerName;
        this.description = description;
      }

      const reviews = [
        new Review(4, "John", "Great product, highly recommended!"),
        new Review(5, "Jane", "I love this item, it's perfect for my needs!"),
        new Review(2, "Jim", "kinda weak but whatever its cheap!"),
        new Review(5, "Jill", "nothing can stop my sorcerer now"),
        new Review(
          3,
          "Juan",
          "I just got it because it was pretty and matched my characters boots"
        ),
        new Review(5, "Jada", "I like it picasso!"),
        new Review(2, "Jorge", "mid"),
        new Review(1, "Jeff", "weak!"),
        new Review(2, "Jordan", "not bad"),
        new Review(4, "Jake", "I love this "),
        new Review(5, "Juliet", "yo that jacket is tight, nawmeann!"),
        new Review(5, "Jae", "it's perfect"),
        new Review(1, "Jon", "doent work for my build"),
        new Review(1, "June", "i want my money back!"),
        new Review(5, "Jess", "love love love"),
        new Review(
          1,
          "Jesus",
          "I died for your sins, and THIS is how you repay me?!"
        ),
        new Review(2, "Joe", "kinda meh but not that bad for the price"),
        new Review(2, "Julian", "doesnt even give that much vitality"),
        new Review(
          5,
          "Jackson",
          "Got this a while back and it's the ONLY helmet I use now!"
        ),
        new Review(5, "James", "best amulet in the game"),
        new Review(5, "Jacob", "Fantastic"),
        new Review(3, "Jessica", "it aight"),
        new Review(5, "Jet", "this helm looks sick on my crusader"),
        new Review(2, "Justin", "ayo"),
        new Review(4, "Juniper", "nice bow. works good"),
        new Review(3, "Julia", "kinda expensive but its pretty"),
        new Review(1, "Josie", "pretty lame"),
        new Review(5, "Joel", "yeah bud!"),
      ];

      // Populate the store items array with at least 15 item objects, with varying data
      const storeItems = [
        new StoreItem(
          1,
          "Rune Helm",
          10.99,
          50,
          5,
          "armour",
          1.99,
          "restores health",
          [reviews[0], reviews[26]],
          "img/product1.jpg",
          null,
          null
        ),
        new StoreItem(
          2,
          "Crooked Broadsword",
          24.99,
          100,
          10,
          "weapon",
          2.99,
          "increased critical damage",
          [reviews[8], reviews[27]],
          "img/product2.jpg",
          null,
          null
        ),
        new StoreItem(
          3,
          "Dark Chestplate",
          15.49,
          25,
          2,
          "armour",
          0.99,
          "restores health",
          [reviews[10]],
          "img/product3.jpg",
          null,
          null
        ),
        new StoreItem(
          4,
          "Saphire Amulet",
          19.99,
          75,
          5,
          "armour",
          1.99,
          "attack bonus",
          [reviews[6], reviews[19], reviews[25]],
          "img/product4.jpg",
          null,
          null
        ),
        new StoreItem(
          5,
          "Silver Britches",
          7.99,
          200,
          20,
          "armour",
          0.45,
          "defense buff",
          [reviews[11]],
          "img/product5.jpg",
          null,
          null
        ),
        new StoreItem(
          6,
          "Horned Helm",
          29.99,
          50,
          5,
          "armour",
          0.99,
          "restores health",
          [reviews[5], reviews[18]],
          "img/product6.jpg",
          null,
          null
        ),
        new StoreItem(
          7,
          "Mighty Crossbow",
          12.99,
          100,
          10,
          "weapon",
          2.99,
          "attack bonus",
          [reviews[7], reviews[9], reviews[24]],
          "img/product7.jpg",
          null,
          null
        ),
        new StoreItem(
          8,
          "Wooden Shield",
          8.99,
          150,
          10,
          "weapon",
          1.99,
          "defense buff",
          [reviews[4]],
          "img/product8.jpg",
          null,
          null
        ),
        new StoreItem(
          9,
          "Bone Shield",
          34.99,
          25,
          2,
          "weapon",
          1.45,
          "defense buff",
          [reviews[15]],
          "img/product9.jpg",
          null,
          null
        ),
        new StoreItem(
          10,
          "Cracked Broadsword",
          14.99,
          75,
          5,
          "weapon",
          1.59,
          "restores health",
          [reviews[12], reviews[17]],
          "img/product10.jpg",
          null,
          null
        ),
        new StoreItem(
          11,
          "Health",
          9.99,
          200,
          20,
          "potion",
          1.99,
          "restores health",
          [reviews[3]],
          "img/product11.jpg",
          null,
          null
        ),
        new StoreItem(
          12,
          "Mana Potion",
          39.99,
          50,
          5,
          "potion",
          1.99,
          "restores mana",
          [reviews[13], reviews[16]],
          "img/product12.jpg",
          null,
          null
        ),
        new StoreItem(
          13,
          "Brass Helm",
          22.99,
          100,
          10,
          "armour",
          2.29,
          "defense boost",
          [reviews[14], reviews[22]],
          "img/product13.jpg",
          null,
          null
        ),
        new StoreItem(
          14,
          "Silver Scimitar",
          18.99,
          150,
          10,
          "weapon",
          1.49,
          "restores mana",
          [reviews[2], reviews[21]],
          "img/product14.jpg",
          null,
          null
        ),
        new StoreItem(
          15,
          "Attack Potion",
          49.99,
          25,
          2,
          "potion",
          1.99,
          "attack bonus for duration",
          [reviews[1], reviews[20], reviews[23]],
          "img/product15.jpg",
          null,
          null
        ),
      ];

      // Initialize filteredItems with all items initially
      filteredItems = storeItems.slice();

      //initialize page load function
      function initialize() {
        // Call the function that will display the first item
        displayItem(currentItemIndex);
        // Call the function that will display the store items array
        displayInventory();
        // Call the function that will display the cart items array
        displayCart();
      }

      // Display the selected item
      function displayItem(index) {
        const item = filteredItems[index];
        const selectedItemDiv = document.getElementById("selected-item");
        const averageRating = calculateAverageRating(item.reviews);
        const warning =
          item.quantityAvailable < 5
            ? `<p class="warning">Only ${item.quantityAvailable} left in stock!</p>`
            : "";
        selectedItemDiv.innerHTML = `
                <h2>${item.name}</h2>
                <img src="${item.image}" alt="${item.name}">
                <p>${item.description}</p>
                <p>Price: ${item.price}</p>
                <p>Average Rating: ${averageRating}</p>
                ${warning}
            `;
        displayReviews(item);
      }

      // Calculate the average rating
      function calculateAverageRating(reviews) {
        if (reviews.length === 0) return "No reviews yet";
        const total = reviews.reduce((sum, review) => sum + review.rating, 0);
        const average = (total / reviews.length).toFixed(1);
        return `${average} / 5 stars`;
      }

      // Toggle reviews visibility
      function toggleReviews() {
        const reviewsDiv = document.getElementById("reviews");
        if (reviewsDiv.style.display === "none") {
          reviewsDiv.style.display = "block";
        } else {
          reviewsDiv.style.display = "none";
        }
      }

      // Display reviews for the selected item
      function displayReviews(item) {
        const reviewsDiv = document.getElementById("reviews");
        reviewsDiv.innerHTML = "";
        item.reviews.forEach((review) => {
          const reviewDiv = document.createElement("div");
          reviewDiv.classList.add("review");
          reviewDiv.innerHTML = `
                    <p>${review.customerName}: ${review.description} (Rating: ${review.rating})</p>
                `;
          reviewsDiv.appendChild(reviewDiv);
        });
        const addReviewButton = document.createElement("button");
        addReviewButton.textContent = "Add a Review";
        addReviewButton.classList.add("toggle-button");
        addReviewButton.onclick = showReviewForm;
        reviewsDiv.appendChild(addReviewButton);
      }

      // Show the review form
      function showReviewForm() {
        const reviewForm = document.getElementById("review-form");
        const productNameSpan = document.getElementById("product-name");
        const item = filteredItems[currentItemIndex];
        productNameSpan.textContent = item.name;
        reviewForm.style.display = "block";
      }

      // Cancel review
      function cancelReview() {
        const reviewForm = document.getElementById("review-form");
        reviewForm.style.display = "none";
      }

      // Show the previous item
      function previousItem() {
        if (currentItemIndex > 0) {
          currentItemIndex--;
          displayItem(currentItemIndex);
        }
      }

      // Show the next item
      function nextItem() {
        if (currentItemIndex < filteredItems.length - 1) {
          currentItemIndex++;
          displayItem(currentItemIndex);
        }
      }

      // Toggle cart visibility
      function toggleCart() {
        const cartDiv = document.getElementById("cart");
        if (cartDiv.style.display === "none") {
          cartDiv.style.display = "block";
        } else {
          cartDiv.style.display = "none";
        }
      }

      // Display the inventory
      function displayInventory() {
        const inventoryDiv = document.getElementById("inventoryOutput");
        inventoryDiv.innerHTML = "";
        filteredItems.forEach((item) => {
          const warning =
            item.quantityAvailable < 5
              ? `<p class="warning">Only ${item.quantityAvailable} left in stock!</p>`
              : "";
          const itemDiv = document.createElement("div");
          itemDiv.classList.add("item");
          itemDiv.innerHTML = `
                    <div>
                        <img src="${item.image}" alt="${item.name}">
                        <p>${item.name}</p>
                        <p>Price: ${item.price}</p>
                        ${warning}
                    </div>
                    <div style="width: 100%; text-align: center;">
                        <button onclick="viewItem(${
                          item.id
                        })">View Item</button>
                        ${
                          item.quantityAvailable > 0
                            ? `<button onclick="addToCartButton(${item.id})">Add to Cart</button>`
                            : `<button disabled>Out of Stock</button>`
                        }
                    </div>
                `;
          inventoryDiv.appendChild(itemDiv);
        });
      }

      // Display filtered items based on category
      function displayFilteredItems() {
        const filter = document.getElementById("displayFilter").value;
        if (filter === "All") {
          filteredItems = storeItems.slice();
        } else {
          filteredItems = storeItems.filter((item) => item.category === filter);
        }
        currentItemIndex = 0;
        displayInventory();
        displayItem(currentItemIndex);
      }

      // View item details
      function viewItem(itemId) {
        const itemIndex = filteredItems.findIndex((item) => item.id === itemId);
        if (itemIndex !== -1) {
          currentItemIndex = itemIndex;
          displayItem(currentItemIndex);
        }
      }

      // Add item to cart from button
      function addToCartButton(itemId) {
        addToCart(itemId, 1);
      }

      // Add item to cart from main display
      function addToCartMain() {
        const item = filteredItems[currentItemIndex];
        addToCart(item.id, 1);
      }

      // Add item to cart
      function addToCart(itemId, quantity) {
        const item = storeItems.find((item) => item.id === itemId);
        const cartItem = cart.find((ci) => ci.item.id === itemId);

        if (
          item &&
          (cartItem
            ? cartItem.quantity + quantity <= item.quantityAvailable
            : quantity <= item.quantityAvailable)
        ) {
          if (cartItem) {
            cartItem.quantity += quantity;
          } else {
            cart.push({ item, quantity });
          }
          displayCart();
        } else {
          alert("Cannot add more items than available in stock.");
        }
      }

      // Display the cart items
      function displayCart() {
        const cartOutputDiv = document.getElementById("cartOutput");
        cartOutputDiv.innerHTML = "";
        let total = 0;
        cart.forEach((cartItem) => {
          const itemTotal = cartItem.item.price * cartItem.quantity;
          total += itemTotal;
          const warning =
            cartItem.item.quantityAvailable - cartItem.quantity < 5
              ? `<div class="cart-item-warning">Only ${
                  cartItem.item.quantityAvailable - cartItem.quantity
                } left in stock!</div>`
              : "";
          cartOutputDiv.innerHTML += `
                    <p>${cartItem.item.name} - ${cartItem.quantity} x ${
            cartItem.item.price
          } = ${itemTotal.toFixed(2)}</p>
                    ${warning}
                `;
        });
        cartOutputDiv.innerHTML += `<p>Total: ${total.toFixed(2)}</p>`;
      }

      // Checkout and confirm purchase
      function checkout() {
        cart.forEach((cartItem) => {
          const item = storeItems.find((si) => si.id === cartItem.item.id);
          item.quantityAvailable -= cartItem.quantity;
        });
        cart = [];
        displayCart();
        displayInventory();
        displayItem(currentItemIndex);
        document.getElementById("checkoutMessage").innerText =
          "Thank you for your purchase!";
      }

      // Convert currency
      function convertCurrency() {
        const currency = document.getElementById("currencySelector").value;
        let conversionFactor = 1;
        if (currency === "USD") {
          conversionFactor = 0.74;
        } else if (currency === "GP") {
          conversionFactor = 400;
        }
        storeItems.forEach((item) => {
          item.price = (item.price * conversionFactor).toFixed(2);
        });
        displayItem(currentItemIndex);
        displayInventory();
        displayCart();
      }

      // Leave a review for an item
      function leaveItemReview() {
        const customerName = document.getElementById("customerNameInput").value;
        const leaveRating = parseInt(
          document.getElementById("leaveRatingInput").value
        );
        const leaveReview = document.getElementById("leaveReviewInput").value;
        const item = filteredItems[currentItemIndex];

        if (customerName === "" || leaveReview === "" || isNaN(leaveRating)) {
          const validationMessage = document.createElement("p");
          validationMessage.innerText = "Please fill out all fields.";
          document.getElementById("addRatingValidationMessage").innerHTML = "";
          document
            .getElementById("addRatingValidationMessage")
            .appendChild(validationMessage);
        } else {
          const validationMessage = document.createElement("p");
          validationMessage.innerText = "Thank you for your input";
          document.getElementById("addRatingValidationMessage").innerHTML = "";
          document
            .getElementById("addRatingValidationMessage")
            .appendChild(validationMessage);

          const review = new Review(leaveRating, customerName, leaveReview);
          item.reviews.push(review);

          // Clear the input fields
          document.getElementById("customerNameInput").value = "";
          document.getElementById("leaveRatingInput").value = "";
          document.getElementById("leaveReviewInput").value = "";

          // Update the item details display to show the new review
          displayItem(currentItemIndex);
          const reviewForm = document.getElementById("review-form");
          reviewForm.style.display = "none";
        }
      }

      // Initialize page load
      document.addEventListener("DOMContentLoaded", initialize);
    </script>
  </body>
</html>
